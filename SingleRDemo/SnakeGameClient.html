<!DOCTYPE html>
<html>
<head>
    <title>SignalR Snake Game Client</title>
    <style type="text/css">
        .container {
            background-color: #99CCFF;
            border: thick solid #808080;
            padding: 20px;
        }

        .playTable td {
            width: 4px;
            height: 4px;
            border: 1px solid black;
        }

        .playTable {
            border-collapse: collapse;
        }
    </style>

    <!--Script references. -->
    <!--Reference the jQuery library. -->
    <script src="Scripts/jquery-1.6.4.min.js"></script>
    <!--Reference the SignalR library. -->
    <script src="Scripts/jquery.signalR-1.1.2.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="signalr/hubs"></script>
    <!--Add script to update the page and send messages.-->
</head>
<body>
    <div>
        <div style="float: left; width: 300px;">
            <div class="container">
                <div>
                    <table>
                        <tr>
                            <td>Player name:</td>
                            <td>
                                <input id="txtPlayerName" type="text" value="" />
                            </td>
                        </tr>
                    </table>
                </div>
                <input type="button" id="btnJoinGame" value="Join Game" />
            </div>
            <div class="container" style="margin-top: 10px;">
                <div>
                    Players :
                </div>
                <div id="divPlayers">
                </div>
            </div>

        </div>
        <div style="float: left; margin-left: 10px;">
            <div id="messages"></div>
            <table>
                <tr>
                    <td>
                        <table id="playTable" class="playTable" cellspacing="0">
                        </table>
                    </td>

                </tr>
            </table>

            <div id="controls">
            </div>
        </div>
    </div>

    <script type="text/javascript">
        var playTableX = 60;
        var playTableY = 60;
        var playTableIsDrawn = false;

        $(document).ready(function () {
        })


        function DrawPlayTable() {
            $("#playTable").empty();
            for (i = 1; i < playTableX; i++) {
                row = $('<tr></tr>');
                for (j = 1; j < playTableY; j++) {
                    row.append($('<td></td>'));
                }
                $("#playTable").append(row);
            }
        }

        function ShowStopApplicationControls() {
            $("#divStopControls").show();
        }


        $(function () {
            // Declare a proxy to reference the hub. 
            var chat = $.connection.cHub;

            chat.client.showTableOnJavascript = function (appArray, players) {
                UpdateGameTable(appArray, players);
            }

            // Start the connection.
            $.connection.hub.start().done(function () {
                $('#btnJoinGame').click(function () {
                    var snakename = $("#txtPlayerName").val();
                    if (snakename.length < 2) {
                        alert('Please input your name !');
                        return;
                    }
                    chat.server.addNewSnake(snakename);
                    $('#btnJoinGame').hide();
                });


                $(document).keydown(function (e) {
                    if (e.keyCode == 37) {
                        chat.server.setDirectionForSnake("left")
                    }

                    if (e.keyCode == 38) {
                        chat.server.setDirectionForSnake("up")
                    }

                    if (e.keyCode == 39) {
                        chat.server.setDirectionForSnake("right")
                    }

                    if (e.keyCode == 40) {
                        chat.server.setDirectionForSnake("down")
                    }

                });

            });
        });


        function UpdateGameTable(table, players) {
            playtable = document.getElementById("playTable");
            if (!playTableIsDrawn || (playtable.rows.length + 1 != playTableX)) {
                playTableX = table.length + 1;
                playTableY = table[0].length + 1;
                DrawPlayTable();
                playTableIsDrawn = true;
            }

            for (i = 0; i < table.length; i++) {
                for (j = 0; j < table[i].length; j++) {
                    if (table[i][j] != 0) {
                        $(playtable.rows[i].cells[j]).css("background-color", GetPlayerColor(table[i][j], players));
                    }
                    else {
                        $(playtable.rows[i].cells[j]).css("background-color", "white");
                    }
                }
            }

            if (players.length == 0) {
                $("#divPlayers").html("No players online yet !");
            }
            else {
                $("#divPlayers").html("");
                for (i = 0; i < players.length; i++) {
                    $("#divPlayers").append("<div style='clear:both'><div style='width:20px;height:20px;float:left;padding-top:3px;background-color:" + players[i].PlayerColor + "'></div> <div style='margin-top:4px;'>" + (i + 1) + "." + players[i].PlayerName + "</div></div>")
                }
            }



        }

        function GetPlayerColor(playerid, players) {
            for (var i = 0; i < players.length; i++) {
                if (players[i].PlayerId == playerid) {
                    return players[i].PlayerColor;
                }
            }
        }
    </script>
</body>
</html>
